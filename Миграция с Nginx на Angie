

Проверка nginx 

nginx -V - покажет инфо по nginx

nginx -T - покажет полную текущую конфигурацию 

nginx -T | grep load_module - покажет загружаемые модули


Установка angie

apt install angie angie-module-{name} - установит angie и желаемый модуль сразу 

apt install angie-modul-{name} - Устанавливает модули из репозитория Angie

sistemctl status nginx - проверяет статус nginx

sistemctl status angie - проверяет статус angie


Рекомендуется отключить автозагрузку angie 

sistemctl disable angie


Конфиг angie 

cd /etc/angie

nano /etc/angie/angie.conf

В конфиге нужно добавить в верхнем уровне контекста дополнительные модули (nginx -T | grep load_module)

angie -t - тест angie



Перенос конфигов командой cp либо через mc, если он есть

/etc/nginx   		/etc/angie 

/sites-available
/sites-enabled
/snippets
/ssl 
dhparam
dhparam.pem
fastcgi.conf - если нужен (сравнить)
mime.types - если нужен (сравнить)
proxy_params - если нужен (сравнить)
scgi_params - если нужен (сравнить)
uwsgi_params - если нужен (сравнить)

nginx.conf - сравнить

Для сравнения использем 

diff /etc/nginx/fastcgi.conf /etc/angie/fastcgi.conf


Сравниваем два конфика nginx.conf и angie.conf и переносим то что должно быть перенесено. 

Не забываем про пути к файлам nginx которые упоменаются в перенесенных настройках конфига

grep -rn '.nginx' /etc/angie

Что бы заменить все можно использовать команду 

find /etc/angie -type f -name '*.conf' -exec sed --follow-symlinks -i 's|/nginx|/angie|g' {} \;


Далее идем в cd /etc/angie/sites-enabled 

ll

И обращаем внимание на /etc/nginx/sites-available/default

total 8
drwxr-xr-x 2 root root 4096 Oct 10 13:22 ./
drwxr-xr-x 8 root root 4096 Oct 13 13:04 ../
lrwxrwxrwx 1 root root   34 Oct 10 13:22 default -> /etc/nginx/sites-available/default
root@ad-ag-zbx-01:/etc/angie/sites-enabled#

Используем 

find /etc/angie/sites-enabled/* -type l -printf 'ln -nsf "$(readlink "%p" | sed s!/etc/nginx/sites-available!/etc/angie/sites-available!)" "$(echo "%p" | sed s!/etc/nginx/sites-available!/etc/angie/sites-available!)"\n' > script.sh

ll - проверяем 

chmod +x script.sh - добавляем права 

./script.sh запускаем скрипт

ll - проверяем


Тестирование конфигурации

sudo angie -t


Переключение на Angie

sudo systemctl stop nginx && sudo systemctl start angie


Включение автозагрузки

sudo systemctl disable nginx

sudo systemctl enable angie

Проверяем. В моем случае Zabbix (http://zabbix6.lan/), который был ранее установлен и работал на nginx запустился без проблем. 


systemctl mask nginx - замаскирует nginx и обезапасит от случайного запуска 


--------------------------------------------------------------------------------------------------------

Миграциā docker-контейнеров

● Меняем в командах docker run образ на Angie
● Работа с конфигами по аналогии с пакетами
● Варианты образов: minimal (без модулей) и обычные (список пакетов)
● В docker-compose.yml также меняем образ
● Восстановление команды docker run:

docker run --rm -v /var/run/docker.sock:/var/run/docker.sock:ro \
 assaflavie/runlike pmm-server
 
● Чтобы выяснить настройки контейнера:

docker inspect {ID|name}

● Запуск нового контейнера:

docker stop nginx && docker run --name angie …
docker rm nginx

Сборка docker-образа

● Формируем свой Dockerfile
● Собираем образ
docker build -t myangie .

● Запускаем контейнер

docker run --rm --name myangie -v /var/www:/usr/share/angie/html:ro \
 -v $(pwd)/angie.conf:/etc/angie/angie.conf:ro -p 8080:80 -d myangie
